+++
date = "2017-04-22T20:45:24+02:00"
title = "Spring Data repository with empty IN clause."
draft = true

+++

The problem I've stabled upon started with a [spring data repository]
(https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.core-concepts) like this:
```java
public interface SampleRepository extends CrudRepository<Sample, Integer>{
    @Query("select s from Sample s where s.id in :ids")
    List<Sample> queryIn(@Param("ids") List<Integer> ids);
}
```
Actual query was of course more complicated that this. Complex enough to justify not using a [query method]
(https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods). 
The problem emerges when you run this method with an empty collection as argument:
```java
repository.queryIn(Collections.emptyList());
```
The result is database dependent - there no problem on H2, but on HSQLDB (and also at least on MSSQL) you get:
```text
Caused by: org.hsqldb.HsqlException: unexpected token: )
	at org.hsqldb.error.Error.parseError(Unknown Source)
	at org.hsqldb.ParserBase.unexpectedToken(Unknown Source)
	...
```
Syntax error in generated SQL query? How come? Lets first look at how `in` clause is handled by hibernate. 
Starting with a query that is run with a non-empty list parameter
```java
repository.queryIn(Arrays.asList(1, 2, 3));
```
the SQL generated by hibernate looks something like this
```sql
select
    sample0_.id as id1_0_,
    sample0_.name as name2_0_ 
from
    sample sample0_ 
where
    sample0_.id in (
        ? , ? , ?
    )
```
Turns out that hibernate can't pass an array directly to the `in` clause. It has to create a sql parameter for 
every entry in the collection.  
Aha, so when the collection passed to the query is empty, the SQL becomes:
```sql
select
    sample0_.id as id1_0_,
    sample0_.name as name2_0_ 
from
    sample sample0_ 
where
    sample0_.id in ()
```
Here is where the syntax error comes in. The SQL standard does require at least one [value expression]
(http://jakewheat.github.io/sql-overview/sql-2011-foundation-grammar.html#_8_4_in_predicate) between the parenthesis.
So the closing bracket `)`, right after `(`, causes HSQLDB's SQL parser to throw a syntax error. Quite rightly though. 

# Solutions

First of all, let me point out, that a corresponding `find..In()` [query method]
(https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods) works fine for an empty 
parameter:
```java
public interface SampleRepository extends CrudRepository<Sample, Integer>{
    List<Sample> findByIdIn(List<Integer> ids);
}
```
So the following test passes:
```java
@Test
public void findByIdIn() {
    List<Sample> result = repository.findByIdIn(Collections.emptyList());
    assertThat(result, empty());
}
```
But what to do, when the query is complex or would yeld a ridiculously long query method name like 
```java
findByProduct_Category_EmployeeResponsible_Departament_Location_CityIn(
   List<City> cities
)
```
You cannot use a custom `@Query`, but there's another option. [JPA Criteria API]
(https://docs.oracle.com/javaee/6/tutorial/doc/gjitv.html). This is what [Spring Data JPA is actually using]
(https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation) under 
the hood to generate JPA queries from query methods. 

The bridge between Criteria API and Spring Data repositories is called [Specifications]
(https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#specifications).



[Sample code](https://github.com/rzymek/sandbox/tree/1a5a01c67c9b0d037d9d800612c2c488c996594e)