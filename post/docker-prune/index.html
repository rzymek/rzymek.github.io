<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Prevent docker from filling up your disk - rzymek&#39;s rumblings</title>
  <meta property="og:title" content="Prevent docker from filling up your disk" />
  <meta name="twitter:title" content="Prevent docker from filling up your disk" />
  <meta name="description" content="Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that last layer with you .war or .js bundle can take a few hundred megabytes. Taking into account, that you should be deploying a new version of every update of the master branch, this can take up a gigabyte every day.">
  <meta property="og:description" content="Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that last layer with you .war or .js bundle can take a few hundred megabytes. Taking into account, that you should be deploying a new version of every update of the master branch, this can take up a gigabyte every day.">
  <meta name="twitter:description" content="Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that …">
  <meta name="author" content="Krzysiek Rzymkowski"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "rzymek&#39;s rumblings",
    
    "url": "https://rzymek.github.io/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https://rzymek.github.io/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https://rzymek.github.io/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https://rzymek.github.io/post/docker-prune/",
          "name": "Prevent docker from filling up your disk"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Krzysiek Rzymkowski"
  },
  "headline": "Prevent docker from filling up your disk",
  "description" : "Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that last layer with you .war or .js bundle can take a few hundred megabytes. Taking into account, that you should be deploying a new version of every update of the master branch, this can take up a gigabyte every day.",
  "inLanguage" : "en",
  "wordCount": 377,
  "datePublished" : "2018-03-30T00:00:00",
  "dateModified" : "2018-03-30T00:00:00",
  "image" : "https://rzymek.github.io/img/rzymek.jpg",
  "keywords" : [ "docker, cron" ],
  "mainEntityOfPage" : "https://rzymek.github.io/post/docker-prune/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https://rzymek.github.io/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https://rzymek.github.io/img/rzymek.jpg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Prevent docker from filling up your disk" />
<meta property="og:description" content="Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that last layer with you .war or .js bundle can take a few hundred megabytes. Taking into account, that you should be deploying a new version of every update of the master branch, this can take up a gigabyte every day.">
<meta property="og:image" content="https://rzymek.github.io/img/rzymek.jpg" />
<meta property="og:url" content="https://rzymek.github.io/post/docker-prune/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="rzymek&#39;s rumblings" />
  <meta name="twitter:title" content="Prevent docker from filling up your disk" />
  <meta name="twitter:description" content="Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick. Docker does reuse the layers that did not change between deployments. But still, that …">
  <meta name="twitter:image" content="https://rzymek.github.io/img/rzymek.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:image" content="https://rzymek.github.io/img/rzymek.jpg" />
  <meta name="twitter:image" content="https://rzymek.github.io/img/rzymek.jpg" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://rzymek.github.io/post/docker-prune/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="rzymek&#39;s rumblings" />

  <meta name="generator" content="Hugo 0.51" />
  <link rel="alternate" href="https://rzymek.github.io/index.xml" type="application/rss+xml" title="rzymek&#39;s rumblings">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://rzymek.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://rzymek.github.io/css/syntax.css" /><link rel="stylesheet" href="https://rzymek.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-54107063-5', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://rzymek.github.io/">rzymek&#39;s rumblings</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="About" href="https://gist.github.com/rzymek/571d5a54fe5f40515488">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="rzymek&#39;s rumblings" href="https://rzymek.github.io/">
            <img class="avatar-img" src="https://rzymek.github.io/img/rzymek.jpg" alt="rzymek&#39;s rumblings" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Prevent docker from filling up your disk</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on March 30, 2018
  
  
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Krzysiek Rzymkowski
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>Deploying docker container as part of your continuous integration can cause your disk to fill up pretty quick.
Docker does reuse the layers that did not change between deployments. But still, that last layer with you <code>.war</code> or <code>.js</code> bundle can take a few hundred megabytes.
Taking into account, that you should be deploying a new version of every update of the <code>master</code> branch, this can take up a gigabyte every day. And you don&rsquo;t really need all those old images and containers on your dev environment.</p>

<p>Docker, by itself, does not do any cleaning up. You need to tell it to. There is the command that <a href="https://docs.docker.com/engine/reference/commandline/system_prune/">removes unused data</a>:</p>

<pre><code>docker system prune
</code></pre>

<p>But still, you need to run it periodically by yourself. Also, you might want to keep those not-that-old container logs for debug purposes.</p>

<h2 id="automatic-cleaning">Automatic cleaning</h2>

<p>The simplest, yet sufficient solution is to run this line daily:</p>

<pre><code>docker system prune -af  --filter &quot;until=$((30*24))h&quot;
</code></pre>

<p>The <code>-a</code> flag will remove all unused images not just dangling ones. The other one (<code>-f</code>) prevents the confirmation prompt.
That&rsquo;s good, cause will be running this command from <code>cron</code>. Last flag (<code>--filter</code>) causes the procedure to spare the images and stopped containers from the last month.</p>

<p>Docker, as it is written in <a href="https://go-lang.org">go</a>, parses time duration strings using <a href="https://golang.org/pkg/time/#ParseDuration">go&rsquo;s build in function</a>. The downside is that the longest unit is supports is <code>h</code> - hour. That&rsquo;s why we can&rsquo;t just pass <em><code>until=30d</code></em>.
We need to specify the number of hours. Writing <code>until=720h</code> does not obviously tell the next maintainer we meant a month. Still, we can use <code>bash</code>&rsquo;s ability to do <a href="http://tldp.org/LDP/abs/html/arithexp.html">basic math</a>. At least the expression <code>30*24h</code> quickly hints we meant 30 days.<br />
Thus <code>--filter &quot;until=$((30*24))h&quot;</code>.</p>

<p>One last thing. Make the system run list line daily.</p>

<p>The <code>/etc/cron.daily</code> directory allows us to not even bother with <a href="https://docs.oracle.com/cd/E12058_01/doc/doc.1014/e12030/cron_expressions.htm"><code>cron</code> expressions</a>.
Just create a file <code>/etc/cron.daily/docker-prune</code>. Make is executable with</p>

<pre><code>chmod +x /etc/cron.daily/docker-prune
</code></pre>

<p>It&rsquo;s contents is just:</p>

<pre><code>#!/bin/bash
docker system prune -af --filter &quot;until=$((30*24))h&quot;
</code></pre>

<h3 id="optional-logging">Optional logging</h3>

<p>If you&rsquo;d like to have some basic logging you can extend the script like this:</p>

<pre><code>#!/bin/bash
log=/var/lib/docker/prune.log
date +'=== %Y.%m.%d %H:%M ===' &gt;&gt; $log
docker system prune -af --filter &quot;until=$((30*24))h&quot; &gt;&gt; $log
</code></pre>

<p>This will cause every execution to add a timestamp and docker&rsquo;s output to <code>/var/lib/docker/prune.log</code> file.</p>


        
          <div class="blog-tags">
            
              <a href="https://rzymek.github.io//tags/docker/">docker</a>&nbsp;
            
              <a href="https://rzymek.github.io//tags/cron/">cron</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://rzymek.github.io/post/what-is-docker/" data-toggle="tooltip" data-placement="top" title="What&#39;s so special about docker?">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://rzymek.github.io/post/simple-docker-service/" data-toggle="tooltip" data-placement="top" title="Simplest Docker service">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:rzymek@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/rzymek" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/krzysztof-rzymkowski" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://stackoverflow.com/users/211205/rzymek" title="StackOverflow">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Krzysiek Rzymkowski
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2018
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://rzymek.github.io/">rzymek&#39;s rumblings</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.51</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://rzymek.github.io/js/main.js"></script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://rzymek.github.io/js/load-photoswipe.js"></script>








  </body>
</html>

